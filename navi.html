<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>星驰笔记本</title>
<style type="text/css">
html,body{  
    height: 100%;  
}
#Container{
    width:100%;
    margin:0 auto;/*设置整个容器在浏览器中水平居中*/
	background:#E8E8E8;
	height:100%;
}
#Header{
    position: fixed;
    float: left;
    height: 50px;
    width: 100%;
    background:#23262E;
}
#Content{
    height: 100%;
    width: 100%;
    padding-top: 50px;
	position: fixed;
}
#Content-Left{
    height: 100%;
    width:15%;
    float:left;/*设置浮动，实现多列效果，div+Css布局中很重要的*/
    background:#F5F5F5;
}
#Content-Main{
	height: 100%;
    width:84.5%;
    float:right;/*设置浮动，实现多列效果，div+Css布局中很重要的*/
	background: #E8E8E8;
}
#tree{
	float:left;
	height:100%;
	width:20%;
	background:#FFFFFF;
}
#note{
	float:right;
	height:100%;
	width:79.9%;
	background:#FFFFFF;
}
#logoImg{
	float: left;
	height: 100%;
}
#logoName{
	float: left;
	text-align: center;
	color: white; 
	line-height: 50px;
	height: 100%;
	margin-left: 10px;
}
.vakata-context li > a { font-size: 13px; }
</style>
<link rel="stylesheet" href="jstree/themes/default/style.min.css" />
<link rel="stylesheet" href="layui/css/layui.css" />
<script src="js/jquery.min.js"></script>
<script src="jstree/jstree.min.js"></script>
<script src="layui/layui.js"></script>
<script>
	layui.use(['layer', 'element'], function(){
	  var layer = layui.layer;
	  var element = layui.element();
	}); 
	function clickFile(){
		alert("我的文件");
	}
	$(function () {
		function getMenu(node){
			var items = {
				newDir: {
					label: "新建目录",
					icon: "./images/addDir.png",
					separator_after: true,
					action: function(obj){
						addDir(obj);
					}
				},
				deleteDir: {
					label: "删除目录",
					icon: "./images/delDir.png",
					separator_after: true,
					action: function(obj){
						delDir(obj);
					}
				},
				reNameDir: {
					label: "重命名",
					icon: "./images/renameDir.png",
					separator_after: true,
					action: function(obj){
						reNameDir(obj);
					}
				},
				newNote: {
					label: "新建笔记",
					icon: "./images/addNote.png",
					separator_after: true,
					action: function(obj){
						addNote(obj);
					}
				},
				deleteNote: {
					label: "删除笔记",
					icon: "./images/delNote.png",
					separator_after: true,
					action: function(obj){
						delNote(obj);
					}
				}
			}
			var isDir = node.a_attr.isDir;
			 if (isDir) {
				delete items.deleteNote;
				if(node.id == "j1_1"){
					delete items.reNameDir;
				}
			 } else {
				delete items.newDir;
				delete items.deleteDir;
				delete items.newNote;
				delete items.reNameDir;
			 }
			return items;
		}
		$('#tree').jstree({
		   'core' : {
			   "themes" : {
				  "variant" : "large"
				},
				"check_callback" : true,
				'data' : {
					  'url' : 'http://127.0.0.1:8080/note/api/v1/file/query',
					  'data' : function (node) {
						return { 'id' : node.id };
					 }
				  }
			},
			"plugins" : [ "contextmenu","dnd", "types" ], 
			"contextmenu" : {
				items : getMenu
			},
			 'types' : {
				"#" : {
					  "max_children" : 1
					}
			} 
		});
		$('#tree').on("changed.jstree", function (e, data) {
			var node = data.node;
			if(typeof(node)!="undefined"){
				var isDir = node.a_attr.isDir;
				if(!isDir){
					$("#note iframe")[0].src="./pages/note/save.html?cmd=detail&id=" + data.node.id;
				}
			}
		});
		$('#tree').on('move_node.jstree', function(e,data){
			 console.info(data);
		})
	  });
	  function addDir(data){
		var obj = getNodeObj(data);
		layer.prompt({
		  value: '',
		  maxlength: 50,
		  title: '请输入目录名',
		}, function(value, index, elem){
		  var param = {
				"name": value,
				"parentId": obj.id == "j1_1" ? null : obj.id
			};
		  $.ajax({
				  type: 'POST',
				  url: "http://127.0.0.1:8080/note/api/v1/dir/create",
				  data: JSON.stringify(param),
				  success: function(){
				  },
				  contentType: "application/json;charset=utf-8"
		  });
		  layer.close(index);
		  refreshTree();
		});    
	  }
	  function addNote(data){
		var obj = getNodeObj(data);
		$("#note iframe")[0].src="./pages/note/save.html?cmd=new&id=" + (obj.id == "j1_1" ? "" : obj.id);
	  }
	  function reNameDir(data){
		var obj = getNodeObj(data);
		layer.prompt({
		  value: '',
		  maxlength: 50,
		  title: '请输入目录名',
		}, function(value, index, elem){
		   $.ajax({
			  type: 'GET',
			  url: "http://127.0.0.1:8080/note/api/v1/dir/rename?id=" + obj.id + "&newName=" + value,
			  success: function(){
			  },
			  contentType: "application/json;charset=utf-8"
		  });
		  refreshTree();
		  layer.close(index);
		});
	  }
	  function delDir (data){
		layer.confirm('是否删除目录?', {icon: 3, title:'提示'}, function(index){
			var obj = getNodeObj(data);
			$.ajax({
				  type: 'GET',
				  url: "http://127.0.0.1:8080/note/api/v1/dir/remove/" + obj.id,
				  success: function(){
					refreshTree();
				  },
				  contentType: "application/json;charset=utf-8"
			});
		  layer.close(index);
		});
	  }
	  function delNote(data){
		var obj = getNodeObj(data);
		layer.confirm('是否删除笔记?', {icon: 3, title:'提示'}, function(index){
		  $.ajax({
			  type: 'GET',
			  url: "http://127.0.0.1:8080/note/api/v1/note/delete/" + obj.id,
			  success: function(){
				refreshTree();
			  },
			  contentType: "application/json;charset=utf-8"
		  });
		  layer.close(index);
		});
	  }
	  function getNodeObj(data){
		var inst = jQuery.jstree.reference(data.reference);
		return inst.get_node(data.reference); 
	  }
	  function refreshTree(){
		$('#tree').jstree("refresh");
	  }
</script>
</head>
 
<body>
<div id="Container">
    <div id="Header">
        <img id="logoImg" src="images/logo.png" /><span id="logoName">星驰笔记本</span>
    </div>
    <div id="Content">
        <div id="Content-Left">
			<ul class="layui-nav layui-nav-tree" lay-filter="demo" style="height:100%">
			  <li class="layui-nav-item"><a href=""><img src="images/menu_file.png"/>&nbsp;&nbsp;我的文件</a></li>
			  <li class="layui-nav-item"><a href=""><img src="images/menu_tag.png"/>&nbsp;&nbsp;我的标签</a></li>
			  <li class="layui-nav-item"><a href=""><img src="images/menu_recycle.png"/>&nbsp;&nbsp;回收站</a></li>
			</ul>
		</div>
        <div id="Content-Main">
			<div id="tree"></div>
			<div id="note">
				<iframe id="detailNote" src="" scrolling="no" height="100%" width="100%" frameborder="0" marginheight="0" marginwidth="0"></iframe>
			</div>
		</div>
    </div>
</div>
</body>
</html>