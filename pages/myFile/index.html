<!DOCTYPE html>
<html>
<head>
    <title>星驰笔记本</title>
	<style type="text/css">
		html,body{  
			height: 100%;  
		}
		#tree{
			float:left;
			height:100%;
			width:20%;
			background:#FFFFFF;
		}
		#note{
			float:right;
			height:100%;
			width:79.9%;
			background:#FFFFFF;
		}
		.vakata-context li > a { font-size: 13px; }
	</style>
	<link rel="stylesheet" href="../../jstree/themes/default/style.min.css" />
	<link rel="stylesheet" href="../../layui/css/layui.css" />
	<script src="../../js/jquery.min.js"></script>
	<script src="../../jstree/jstree.min.js"></script>
	<script src="../../layui/layui.js"></script>
	<script>
		layui.use(['layer'], function(){
		  var layer = layui.layer;
		}); 
		$(function () {
			function getMenu(node){
				var items = {
					newDir: {
						label: "新建目录",
						icon: "../../images/addDir.png",
						separator_after: true,
						action: function(obj){
							addDir(obj);
						}
					},
					deleteDir: {
						label: "删除目录",
						icon: "../../images/delDir.png",
						separator_after: true,
						action: function(obj){
							delDir(obj);
						}
					},
					reNameDir: {
						label: "重命名",
						icon: "../../images/renameDir.png",
						separator_after: true,
						action: function(obj){
							reNameDir(obj);
						}
					},
					newNote: {
						label: "新建笔记",
						icon: "../../images/addNote.png",
						separator_after: true,
						action: function(obj){
							addNote(obj);
						}
					},
					deleteNote: {
						label: "删除笔记",
						icon: "../../images/delNote.png",
						separator_after: true,
						action: function(obj){
							delNote(obj);
						}
					}
				}
				var isDir = node.a_attr.isDir;
				 if (isDir) {
					delete items.deleteNote;
					if(node.id == "j1_1"){
						delete items.reNameDir;
					}
				 } else {
					delete items.newDir;
					delete items.deleteDir;
					delete items.newNote;
					delete items.reNameDir;
				 }
				return items;
			}
			$('#tree').jstree({
			   'core' : {
				   "themes" : {
					  "variant" : "large"
					},
					"check_callback" : true,
					'data' : {
						  'url' : 'http://127.0.0.1:8080/note/api/v1/file/query',
						  'data' : function (node) {
							return { 'id' : node.id };
						 }
					  }
				},
				"plugins" : [ "contextmenu","dnd", "types" ], 
				"contextmenu" : {
					items : getMenu
				},
				 'types' : {
					"#" : {
						  "max_children" : 1
						}
				} 
			});
			$('#tree').on("changed.jstree", function (e, data) {
				var node = data.node;
				if(typeof(node)!="undefined"){
					var isDir = node.a_attr.isDir;
					if(!isDir){
						$("#note iframe")[0].src="./save.html?cmd=detail&id=" + data.node.id;
					}
				}
			});
			$('#tree').on('move_node.jstree', function(e,data){
				 console.info(data);
			})
		  });
		  function addDir(data){
			var obj = getNodeObj(data);
			layer.prompt({
			  value: '',
			  maxlength: 50,
			  title: '请输入目录名',
			}, function(value, index, elem){
			  var param = {
					"name": value,
					"parentId": obj.id == "j1_1" ? null : obj.id
				};
			  $.ajax({
					  type: 'POST',
					  url: "http://127.0.0.1:8080/note/api/v1/dir/create",
					  data: JSON.stringify(param),
					  success: function(){
					  },
					  contentType: "application/json;charset=utf-8"
			  });
			  layer.close(index);
			  refreshTree();
			});    
		  }
		  function addNote(data){
			var obj = getNodeObj(data);
			$("#note iframe")[0].src="./save.html?cmd=new&id=" + (obj.id == "j1_1" ? "" : obj.id);
		  }
		  function reNameDir(data){
			var obj = getNodeObj(data);
			layer.prompt({
			  value: '',
			  maxlength: 50,
			  title: '请输入目录名',
			}, function(value, index, elem){
			   $.ajax({
				  type: 'GET',
				  url: "http://127.0.0.1:8080/note/api/v1/dir/rename?id=" + obj.id + "&newName=" + value,
				  success: function(){
				  },
				  contentType: "application/json;charset=utf-8"
			  });
			  refreshTree();
			  layer.close(index);
			});
		  }
		  function delDir (data){
			layer.confirm('是否删除目录?', {icon: 3, title:'提示'}, function(index){
				var obj = getNodeObj(data);
				$.ajax({
					  type: 'GET',
					  url: "http://127.0.0.1:8080/note/api/v1/dir/remove/" + obj.id,
					  success: function(){
						refreshTree();
					  },
					  contentType: "application/json;charset=utf-8"
				});
			  layer.close(index);
			});
		  }
		  function delNote(data){
			var obj = getNodeObj(data);
			layer.confirm('是否删除笔记?', {icon: 3, title:'提示'}, function(index){
			  $.ajax({
				  type: 'GET',
				  url: "http://127.0.0.1:8080/note/api/v1/note/delete/" + obj.id,
				  success: function(){
					refreshTree();
				  },
				  contentType: "application/json;charset=utf-8"
			  });
			  layer.close(index);
			});
		  }
		  function getNodeObj(data){
			var inst = jQuery.jstree.reference(data.reference);
			return inst.get_node(data.reference); 
		  }
		  function refreshTree(){
			$('#tree').jstree("refresh");
		  }
	</script>
</head>
<body>
	<div id="tree"></div>
	<div id="note">
		<iframe id="detailNote" src="" height="100%" width="100%" frameborder="0" marginheight="0" marginwidth="0"></iframe>
	</div>
</html>