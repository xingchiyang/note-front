<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>星驰笔记本</title>
	<style type="text/css">
		html,body{  
			height: 100%;  
		}
		#list{
			float:left;
			height:100%;
			width:250px;
			background:#FFFFFF;
			overflow: auto;
		}
		#file{
			height:100%;
			margin-left: 255px;
			background:#FFFFFF;
		}
	</style>
	<link rel="stylesheet" href="../../layui/css/layui.css" />
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/jquery.contextMenu.js"></script>
	<script src="../../jstree/jstree.min.js"></script>
	<script src="../../layui/layui.js"></script>
	<script>
		layui.use(['layer'], function(){
		  var layer = layui.layer;
		}); 
		$(function () {
			Date.prototype.format = function (format) {
				var o = {  
					"M+": this.getMonth() + 1,  
					"d+": this.getDate(),  
					"h+": this.getHours(),  
					"m+": this.getMinutes(),  
					"s+": this.getSeconds(),  
					"q+": Math.floor((this.getMonth() + 3) / 3),  
					"S": this.getMilliseconds()  
				}  
				if (/(y+)/.test(format)) {  
					format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));  
				}  
				for (var k in o) {  
					if (new RegExp("(" + k + ")").test(format)) {  
						format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));  
					}  
				}  
				return format;  
			} 
			loadList();
		});
		function addListener(){
			$('.file').contextMenu('myMenu', {
				bindings: {
					'resume': function(t) {
						var id = t.id;
						var filetype = t.getAttribute("filetype");
						if(filetype == "dir"){
							$.ajax({
								  type: 'GET',
								  url: "/note/api/v1/dir/resume/" + id,
								  success: function(data){
									refreshList();
								  },
								  contentType: "application/json;charset=utf-8"
							});
						} else if(filetype == "note"){
							$.ajax({
								  type: 'GET',
								  url: "/note/api/v1/note/resume/" + id,
								  success: function(data){
									refreshList();
								  },
								  contentType: "application/json;charset=utf-8"
							});
						}
					},
					'delete': function(t) {
						var id = t.id;
						var filetype = t.getAttribute("filetype");
						if(filetype == "dir"){
							layer.confirm('是否删除目录?', {icon: 3, title:'提示'}, function(index){
								$.ajax({
									  type: 'GET',
									  url: "/note/api/v1/dir/clear/" + id,
									  success: function(data){
										refreshList();
									  },
									  contentType: "application/json;charset=utf-8"
								});
								layer.close(index);
							});
						} else if(filetype == "note"){
							layer.confirm('是否删除笔记?', {icon: 3, title:'提示'}, function(index){
								$.ajax({
									  type: 'GET',
									  url: "/note/api/v1/note/clear/" + id,
									  success: function(data){
										refreshList();
									  },
									  contentType: "application/json;charset=utf-8"
								});
								layer.close(index);
							});
						}
					},
					'deleteAll': function(t) {
						layer.confirm('回收站清空后无法恢复，是否继续?', {icon: 3, title:'提示'}, function(index){
							$.ajax({
								  type: 'GET',
								  url: "/note/api/v1/file/recycle/empty",
								  success: function(data){
									refreshList();
								  },
								  contentType: "application/json;charset=utf-8"
							});
							layer.close(index);
						});
					}
				}
			});
		}
		function loadList(){
			$.ajax({
				  type: 'GET',
				  url: "/note/api/v1/file/recycle/query",
				  success: function(data){
					var dirs = data.dirs;
					var notes = data.notes;
					if(dirs != null && dirs.length > 0){
						for(key in dirs){
							$('#list tbody').append(getDirHtml(dirs[key]));
						}
					}
					if(notes != null && notes.length > 0){
						for(key in notes){
							$('#list tbody').append(getNoteHtml(notes[key]));
						}
					}
					addListener();
				  },
				  contentType: "application/json;charset=utf-8"
			});
		}
		function refreshList(){
			$('#list tbody').html("");
			loadList();
		}
		function getDirHtml(dir){
			var html = "";
			html += "<tr class='file' onclick=\"showDir()\" id='" + dir.id + "' filetype='dir'>";
			html += "<td><img src='../../images/dir.png'/>&nbsp;" + dir.name + "</td>";
			html += "<td>" + formatDate(dir.createTime) + "</td></tr>";
			return html;
		}
		function getNoteHtml(note){
			var html = "";
			html += "<tr class='file' onclick=\"showNote('" + note.id + "')\" id='" + note.id + "' filetype='note'>";
			html += "<td><img src='../../images/file.png'/>&nbsp;" + note.title + "</td>";
			html += "<td>" + formatDate(note.createTime) + "</td></tr>";
			return html;
		}
		function formatDate(time){
			return new Date(time).format("yyyy-MM-dd");
		}
		function showNote(noteId){
			$("#detailNote")[0].src="./detail.html?id=" + noteId;
		}
		function showDir(){
			$("#detailNote")[0].src="";
		}
	</script>
</head>
<body>
	<div class="contextMenu" id="myMenu" style="display:none;">
	  <ul>
		<li id="resume">恢复</li>
		<li id="delete">删除</li>
		<li id="deleteAll">清空回收站</li>
	  </ul>
	</div>
	
	<div id="list">
		<table class="layui-table" lay-even lay-skin="nob">
		  <tbody></tbody>
		</table>
	</div>
	
	<div id="file">
		<iframe id="detailNote" src="" scrolling="no"  height="100%" width="100%" frameborder="0" marginheight="0" marginwidth="0"></iframe>
	</div>
</body>
</html>